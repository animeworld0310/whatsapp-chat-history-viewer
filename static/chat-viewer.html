<!DOCTYPE html>
<html>
	<head>
        <!-- von https://www.bootdey.com/snippets/view/messages-chat-with-tabs -->

        <title>Chat</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"/>
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css"/>
        <link rel="stylesheet" type="text/css" href="chat-viewer.css"/>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js"></script>
        <script>

            var entityMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;',
                '`': '&#x60;',
                '=': '&#x3D;'
            };

            function escapeHtml (string) {
                return String(string).replace(/[&<>"'`=\/]/g, function (s) {
                    return entityMap[s];
                });
            }

              $(function() {
                $.getJSON('/api/chats', null, function(data, textStatus, jqXHR) {
                    data.chats.forEach(element => {
                        let active = (element.id == -1) ? ' class="chat-menu-item active"' : 'class="chat-menu-item"';
                        $("#contacts").append('<li data-toggle="tab" id="chat-' + element.id + '" data-target="#inbox-message-' + element.id + '"' + active + '>' +
                                    '   <!--<div class="message-count"> 1 </div>-->' +
                                    '   <img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar7.png">' +
                                    '    <div class="vcentered info-combo">' +
                                    '        <h3 class="no-margin-bottom name"><a href="javascript:loadChat(\'' + escapeHtml(element.name) + '\', ' + element.id + ')">' + escapeHtml(element.name) + '</a></h3>' +
/*                                    '        <h5>((Letzte Chat-Message))</h5>' +
*/                                    '    </div>' +
/*                                    '    <div class="contacts-add">' +
                                    '        <span class="message-time">((Uhrzeit))</span>' +
                                    '    </div>' +
*/                                    '</li>');
                    });
                })
                .fail(function (jqxhr,settings,ex) { alert('failed, '+ ex); });
              });

              function getMediaForDate(images, video, date) {
                  let media = [];
                  (!!images[date]) && images[date].files.forEach(file => { media.push({ 'type': 'image', 'file': file }); });
                  (!!video[date]) && video[date].files.forEach(file => { media.push({ 'type': 'video', 'file': file }); });
                  return media;
              }

              function loadChat(name, id) {
                    // highlight new selection in person list
                    $(".chat-menu-item").removeClass("active");
                    $("#chat-" + id).addClass("active");

                    // reload chat content
                    $("#chat-content").empty();
                    $.getJSON('/api/chat?name=' + name, null, function(data, textStatus, jqXHR) {
                        Object.keys(data.messages).forEach(date => {
                                // Anzeige des Datums
                                $("#chat-content").append(
                                '<div class="message system">' +
                                '            <div class="message-text system">' +
                                                escapeHtml(date) +
                                '            </div>' +
                                '    </div>');

                                // TODO: We need to show all media
                                let mineMedia = getMediaForDate(data.images.mine, data.video.mine, date);
                                let otherMedia = getMediaForDate(data.images.other, data.video.other, date);

                                data.messages[date].forEach(message => {
                                    if (!!message.person) {
                                        // Anzeige einer Message
                                        let text = '';
                                        if (message.text.includes('<Media omitted>')) {
                                            let media = (message.myself) ? mineMedia : otherMedia;
                                            if (media.length > 0) {
                                                if (media[0].type == 'image') {
                                                    text = 'Image: <img src="/static/images/' + ((message.myself) ? 'Sent/' : '') + media[0].file + '" width="80%" height="80%" />';
                                                } else {
                                                    text = '((Video)) ' + media[0].file;
                                                }
                                            }
                                            else {
                                                text = 'Image not available';
                                            }
                                        } else {
                                            message.text.forEach(line => {
                                                text += escapeHtml(line) + '<br />';
                                            });
                                        }
                                        let type = (message.myself) ? ' my-message' : 'info';
                                        $("#chat-content").append(
                                        '<div class="message ' + type + '">' +
                                        '        <img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar7.png">' +
                                        '        <div class="message-body">' +
                                        '            <div class="message-info">' +
                                        '                <h4>' + message.person + '</h4>' +
                                        '                <h5> <i class="fa fa-clock-o"></i>' + message.date.time + '</h5>' +
                                        '            </div>' +
                                        '            <hr>' +
                                        '            <div class="message-text">' +
                                                        text +
                                        '            </div>' +
                                        '        </div>' +
                                        '        <br>' +
                                        '    </div>');
                                    } else if (!!message.text) {
                                        // Anzeige von Systemnachrichten
                                        $("#chat-content").append(
                                        '<div class="message system">' +
                                        '        <div class="message-body system">' +
                                        '            <div class="message-info system">' +
                                        '                <h5> <i class="fa fa-clock-o"></i>' + message.date.time + '</h5>' +
                                        '            </div>' +
                                        '            <hr>' +
                                        '            <div class="message-text system">' +
                                                        escapeHtml(message.text[0]) +
                                        '            </div>' +
                                        '        </div>' +
                                        '        <br>' +
                                        '    </div>');
                                    }
                                });
                        });
                    });
              }
        </script>
	</head>
	<body>
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <div class="container">
            <div class="panel messages-panel">
                <div class="contacts-list">
                    <div class="tab-content">
                        <div id="inbox" class="contacts-outter-wrapper tab-pane active">
                            <div class="contacts-outter">
                                <ul id="contacts" class="list-unstyled contacts">
                                    <!-- EnthÃ¤lt die Liste der Chats -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="tab-content">
                    <div class="tab-pane message-body active">
                        <div class="message-chat">
                            <div class="chat-body" id="chat-content">
<!--
                                <div class="message info">
                                    <img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar1.png">
                                    <div class="message-body">
                                        <div class="message-info">
                                            <h4> ((Name)) </h4>
                                            <h5> <i class="fa fa-clock-o"></i> ((Uhrzeit)) </h5>
                                        </div>
                                        <hr>
                                        <div class="message-text">
                                            I've seen your new template, Dauphin, it's amazing !
                                        </div>
                                    </div>
                                    <br>
                                </div>
        
                                <div class="message my-message">
                                    <img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar1.png">
        
                                    <div class="message-body">
                                        <div class="message-body-inner">
                                            <div class="message-info">
                                                <h4> Dennis Novac </h4>
                                                <h5> <i class="fa fa-clock-o"></i> 2:28 PM </h5>
                                            </div>
                                            <hr>
                                            <div class="message-text">
                                                Thanks, I think I will use this for my next dashboard system.
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                </div>
        
                                <div class="message info">
                                    <img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar1.png">
        
                                    <div class="message-body">
                                        <div class="message-info">
                                            <h4> Elon Musk </h4>
                                            <h5> <i class="fa fa-clock-o"></i> 2:32 PM </h5>
                                        </div>
                                        <hr>
                                        <div class="message-text">
                                            Hah, too late, I already bought it and my team is impleting the new design right now.
                                        </div>
                                    </div>
                                    <br>
                                </div>
                                -->
                            </div>
                        </div>
                    </div>
        
        
                </div>
            </div>
        </div>	
    </body>
</html>
